<!doctype html>
<html>

<head>
    <meta charset="ISO-8859-1">
    <title>icodingclub</title>
    <link href="/resource/css/base.css" rel="stylesheet">

</head>

<body>
    <div class="wrraper table">
        <div class="tableRow">
            <header class="content tableCell">
                <img class="logo" src="/resource/image/icodingclub.jpg">
            </header>
        </div>

        <div class="demo">

            <p>
                <label>Image File:</label>
                <input type="file" id="imageLoader" name="imageLoader" />
            </p>

            <div class="imageCropper">
                <div class="titleLabel ">Zoom and pan</div>

                <div class="content" style="border:1px solid gray">
                    <canvas id="panel" width="620" height="220"></canvas>

                </div>

            </div>

        </div>



    </div>


    <footer>

        footer
    </footer>

    <script type="text/javascript">
    var imageCropper = {


        ctx: null,

        image: new Image(),


        click: false,


        downPointX: 0,

        downPointY: 0,

        lastPointX: 0,

        lastPointY: 0,

        cropedFile: null,

        resize: false,

        canvasBackgroundColor: "#FFFFFF",

        init: function() {
            this.ctx = document.getElementById("panel").getContext("2d");
            var imageUploader = document.getElementById('imageLoader');
            //imageLoader.addEventListener('change', this.handleImage.bind(this), false);
            this.initCanvas();
        },

        handleImage: function(event) {
            console.log("Image picked");
            // var reader = new FileReader();


            // reader.onload = function(event) {
            //     console.log("Image loaded");
            //     var img = new Image();
            //     img.onload = function() {

            //         console.log("Image loaded 2");
            //         this.initCanvas(img);`
            //     }.bind(this);
            //     img.src = event.target.result;
            // }.bind(this);

            // reader.readAsDataURL(event.target.files[0]);



        },

        initCanvas: function(image) {
            this.image = new Image();
            this.image.src = "800px-Google.png";
            this.image.onload = function() {
                this.ctx.canvas.width = this.image.width;
                this.ctx.canvas.height = this.image.height;
                this.reDrawCanvas();
                this.initEventsOnCanvas();
            }.bind(this);

        },

        initEventsOnCanvas: function() {
            this.ctx.canvas.onmousedown = this.onMouseDown.bind(this);
            this.ctx.canvas.onmouseup = this.onMouseUp.bind(this);
        },


        onMouseDown: function(e) {
            var loc = this.windowToCanvas(e.clientX, e.clientY);

            e.preventDefault();


            this.click = true;


            if (!this.resize) {

                this.ctx.canvas.onmousemove = this.onMouseMove.bind(this);
                this.downPointX = loc.x;
                this.downPointY = loc.y;
                this.lastPointX = loc.x;
                this.lastPointY = loc.y;

            }


        },

        onMouseMove: function(e) {
            e.preventDefault();
            //TODO: Add as separte event
            //this.detectResizerBoxHover(e);
            if (this.click) {
                var loc = this.windowToCanvas(e.clientX, e.clientY);
                this.lastPointX = loc.x;
                this.lastPointY = loc.y;
                this.reDrawCanvas();
            }

        },

        onMouseUp: function(e) {
            e.preventDefault();

            this.ctx.canvas.onmousemove = this.onImageResize.bind(this);
            this.click = false;

        },
        onMouseDownForResize: function(e) {
            var loc = this.windowToCanvas(e.clientX, e.clientY);

            e.preventDefault();
            this.click = true;


        },



        reDrawCanvas: function() {
            this.clearCanvas();
            this.drawImage();
            this.drawSelRect();
            this.drawResizerBox();
        },

        clearCanvas: function() {


            this.ctx.clearRect(0, 0, this.ctx.canvas.width, this.ctx.canvas.height);
            //Making default background color to white, gif images was giving problem.    
            this.ctx.fillStyle = this.canvasBackgroundColor;
            this.ctx.fillRect(0, 0, this.ctx.canvas.width, this.ctx.canvas.height);

        },

        drawImage: function() {

            console.log("In draw image: ", this.image);
            this.ctx.drawImage(this.image, 0, 0);
        },

        drawSelRect: function() {

            console.log(this.downPointX, this.downPointY, this.lastPointX, this.lastPointY);
            this.ctx.strokeStyle = '#000000';
            this.ctx.lineWidth = 1;
            this.ctx.strokeRect(this.downPointX, this.downPointY, (this.lastPointX - this.downPointX), (this.lastPointY - this.downPointY));

        },

        onImageResize: function(e) {

            var centerPointX = (this.lastPointX + this.downPointX) / 2;
            var centerPointY = (this.lastPointY + this.downPointY) / 2;

            var loc = this.windowToCanvas(e.clientX, e.clientY);
            this.ctx.fillStyle = '#FF0000';
            this.ctx.lineWidth = 1;



            // 
            // 
            // 


            if (this.isResizeBoxHover(loc, centerPointX, this.downPointY)) {
                if (this.click) {
                    this.downPointY = loc.y;
                    this.reDrawCanvas();
                }

            } else if (this.isResizeBoxHover(loc, this.lastPointX, centerPointY)) {
                if (this.click) {
                    this.lastPointX = loc.x;
                    this.reDrawCanvas();
                }
            } else if (this.isResizeBoxHover(loc, centerPointX, this.lastPointY)) {
                if (this.click) {
                    this.lastPointY = loc.y;
                    this.reDrawCanvas();
                }
            } else if (this.isResizeBoxHover(loc, this.downPointX, centerPointY)) {
                if (this.click) {
                    this.downPointX = loc.x;
                    this.reDrawCanvas();
                }

            } else {
                this.resize = false;
            }
        },


        isResizeBoxHover: function(loc, xPoint, yPoint) {

            if (loc.x > (xPoint - 5) && loc.x < (xPoint + 5) && loc.y > (yPoint - 5) && loc.y < (yPoint + 5)) {

                this.ctx.fillRect(xPoint - 5, yPoint - 5, 10, 10);
                this.resize = true;
                return true;
            }
            return false;

        },


        drawResizerBox: function() {

            var centerPointX = (this.lastPointX + this.downPointX) / 2;
            var centerPointY = (this.lastPointY + this.downPointY) / 2;

            this.ctx.fillStyle = '#000000';
            this.ctx.lineWidth = 1;
            this.ctx.fillRect(centerPointX - 5, this.downPointY - 5, 10, 10);
            this.ctx.fillRect(this.lastPointX - 5, centerPointY - 5, 10, 10);
            this.ctx.fillRect(centerPointX - 5, this.lastPointY - 5, 10, 10);
            this.ctx.fillRect(this.downPointX - 5, centerPointY - 5, 10, 10);



        },

        windowToCanvas: function(x, y) {
            var canvas = this.ctx.canvas,
                bbox = canvas.getBoundingClientRect();
            return {
                x: x - bbox.left * (canvas.width / bbox.width),
                y: y - bbox.top * (canvas.height / bbox.height)
            };
        },

    }


    imageCropper.init();
    </script>
</body>

</html>