<section>
    <h1 class="section-heading">
        Introduction
        <span class="arrow"></span>
    </h1>
    <br> 

     <h1 class="articleTitle">SPRING JMS WITH APACHE ACTIVEMQ IN EMBEDDED MODE IN TOMCAT</h1>

    In my last blog, i gave the basic overview of Spring JMS with ActiveMQ
    <br />
    <a href="http://icodingclub.blogspot.com/2011/07/introduction-of-spring-jms-with.html">Introduction of Spring JMS with ActiveMQ</a>
    <br />
    <br /> Though above article is good to understand basic working of Spring JMS with ActiveMQ but this is not what we do in software industry or in professional projects.
    <br />
    <br /> The most common use case is to use ActiveMQ as embedded JMS broker in any application server.
    <br /> For this blog i will use Tomcat as application server and we try to embedded the ActiveMQ in that.
    <br />
    <br />
    <i><b>Note:</b> If for some reason you are not interested with ActiveMQ, i have another blog page with same stuff with HornetQ</i>
    <br />
    <a href="http://icodingclub.blogspot.com/2011/09/spring-jms-with-embeded-hornetq-in.html">Spring JMS with embeded HornetQ in tomcat</a>
    <br />
    <br />
    <br />
    <h3>Agenda</h3>
    <ol>
        <li>Create a web application for sending JMS message: JMSSenderAMQ</li>
        <li>Create a web application to listen JMS message: JMSListnerAMQ</li>
        <li>Configure Sender and Listner tomcat for embeded ActiveMQ.</li>
        <li>Working Demo of Listener and Sender </li>
        <li>Enable JMX monitoring. </li>
        <li>Write a simple application for JMX monitoring.</li>
        <li>Working Demo of JMX Monitoring application. </li>
    </ol>


    <h3>Prerequisite</h3>
    <ol>
        <li>Basic knowledge of spring and spring MVC.</li>
        <li>Basic knowledge of working of tomcat.</li>
    </ol>

     <h3>Requirement</h3>
    <ol>
        <li><span style="font-size: large;"><span style="font-size: small;">two tomact 6 server.</span></span>
        </li>
        <li><span style="font-size: large;"><span style="font-size: small;">ActiveMQ 5.5.</span></span>
        </li>
        <li><span style="font-size: large;"><span style="font-size: small;"> </span><u></u>
            </span> Spring 3.0.5.RELEASE</li>
        <li>Eclipse IDE</li>
    </ol>

    <h3>Jars</h3>

    <br />
    <br />
    <div class="separator" style="clear: both; text-align: center;">
        <a href="http://1.bp.blogspot.com/-2wlFKUWjBfk/TnttMNrMtNI/AAAAAAAAAK8/QHLRrmrBnI8/s1600/jarImg.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-2wlFKUWjBfk/TnttMNrMtNI/AAAAAAAAAK8/QHLRrmrBnI8/s1600/jarImg.png" />
        </a>
    </div>
    <div class="separator" style="clear: both; text-align: center;">
        <a href="http://2.bp.blogspot.com/-wupfsceOnVY/TnsJXySDdQI/AAAAAAAAAK4/xFEwTaLbLfg/s1600/jarImg.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;">
            <br />
        </a>
    </div>
    <br />
    <br />

     <h3>Assumptions</h3>
    <br />
    <ol>
        <li><span style="font-size: large;"><span style="font-size: small;">ACTIVE_MQ_PATH: The installation directory of activemq</span></span>
        </li>
        <li><span style="font-size: large;"><span style="font-size: small;">TOMCAT_SEN_PATH: The installation directory of Tomcat Sender Server</span></span>
        </li>
        <li><span style="font-size: large;"><span style="font-size: small;">TOMCAT_LIS_PATH: The installation directory of Tomcat Listener Server</span><u><br />
</u>
            </span>
        </li>
    </ol>
    <br />

     <h3>Project Structure</h3>
     
    <br />
    <div class="separator" style="clear: both; text-align: center;"></div>
    <div class="separator" style="clear: both; text-align: center;">
        <a href="http://4.bp.blogspot.com/-H6M0WhqU5DA/TnlA2JZ7PyI/AAAAAAAAAKw/q536Q767TzE/s1600/App+-+Copy.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-H6M0WhqU5DA/TnlA2JZ7PyI/AAAAAAAAAKw/q536Q767TzE/s1600/App+-+Copy.png" />
        </a>
    </div>
    <a href="http://3.bp.blogspot.com/-rUEcit4fwnw/Tnk77-4vZyI/AAAAAAAAAKs/DloJlvag4Ms/s1600/App+-+Copy.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;">
        <br />
    </a>
    <br />
    <br />
    <br /> We will have two web application, deployed in different server.
    <br /> First: JMSSenderAMQ will be responsible to create a JMS message and to send it to Listener.
    <br /> Second: JMXListnerAMQ will consume the JMS message. this application will also be responsible to start the ActiveMQ and provides its configuration parameter.
    <br />
    <br />
    <i>NOTE: The thumb rule to know that ActiveMQ is running in embedded mode or not ?, is that you never have to stat the ActiveMQ separately, it started by the server and all its configuration is decided by server.</i>
    <br />
    <br />

</section>


<section>


     <h1 class="section-heading">
        Development
        <span class="arrow"></span>
    </h1>
    <br> 
    <br />
    <br />
    <h3>Introduction</h3>
    <br />
    <br />
    <br />
    <u>JMSSEnder Server configuration</u>
    <br /> Start the process by dumping all the jars in lib folder of tomcat.
    <br /> Why ??
    <br /> Point is when you start the server, its do the JNDI configuration, for this its need activemq jars and spring jars
    <br /> because of this, you can't bypass this step by just adding your jar in your project.
    <br />
    <br /> Next step is to modify the config file in tomcat
    <br />
    <br /> TOMCAT_SEN_PATH/conf/server.xml
    <br />
    <pre class="prettyprint lang-xml">


&lt;resource auth=&quot;Container&quot; brokername=&quot;FooBroker&quot; brokerurl=&quot;tcp://127.0.0.1:61616&quot; description=&quot;JMS Connection Factory&quot; factory=&quot;org.apache.activemq.jndi.JNDIReferenceFactory&quot; name=&quot;jms/ConnectionFactory&quot; type=&quot;org.apache.activemq.ActiveMQConnectionFactory&quot;&gt;&lt;/resource&gt;

&lt;resource auth=&quot;Container&quot; description=&quot;A sample queue&quot; factory=&quot;org.apache.activemq.jndi.JNDIReferenceFactory&quot; name=&quot;jms/FooQueue&quot; physicalname=&quot;TEST.Q1&quot; type=&quot;org.apache.activemq.command.ActiveMQQueue&quot;&gt;&lt;/resource&gt;



</pre>
    <br /> TOMCAT_SEN_PATH/conf/context.xml
    <br />
    <pre class="prettyprint lang-xml">

&lt;resourcelink global=&quot;jms/ConnectionFactory&quot; name=&quot;jms/ConnectionFactory&quot;&gt;&lt;/resourcelink&gt;
&lt;resourcelink global=&quot;jms/FooQueue&quot; name=&quot;jms/FooQueue&quot;&gt;
&lt;/resourcelink&gt;


</pre>
    <br />
    <br />
    <u>Building JMSSenderAMQ </u>
    <br />
    <br /> Now lets start building the sender web application
    <br /> Update the web.xml as below
    <br />
    <br />
    <u>/WEB-INF/web.xml</u>
    <br />
    <br />
    <ol>
        <li><span style="font-size: large;"><span style="font-size: small;">Application context setup with servlet context</span></span>
        </li>
        <li><span style="font-size: large;"><span style="font-size: small;">JNDI setup for connection</span></span>
        </li>
        <li><span style="font-size: large;"><span style="font-size: small;">JNDI setup for queue name</span><u><br />
</u>
            </span>
        </li>
    </ol>
    <br />
    <pre class="prettyprint lang-xml">


&lt;web-app version=&quot;2.4&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns=&quot;http://java.sun.com/xml/ns/j2ee&quot; xsi:schemalocation=&quot;http://java.sun.com/xml/ns/j2ee 
         http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd&quot;&gt;
    
    &lt;context-param&gt;
      &lt;param-name&gt;log4jConfigLocation&lt;/param-name&gt;&lt;param-value&gt;/WEB-INF/classes/log4j.xml&lt;/param-value&gt;&lt;/context-param&gt;
    &lt;listener&gt;
      &lt;listener-class&gt;org.springframework.web.util.Log4jConfigListener&lt;/listener-class&gt;
    &lt;/listener&gt;
    
    &lt;context-param&gt;
      &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;&lt;param-value&gt;/WEB-INF/spring/jms-context.xml&lt;/param-value&gt;&lt;/context-param&gt;
    &lt;listener&gt;
      &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;
    &lt;/listener&gt;
    &lt;servlet&gt;
      &lt;servlet-name&gt;JMSSenderAMQ&lt;/servlet-name&gt;
      &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;
      &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
    &lt;/servlet&gt;
    &lt;servlet-mapping&gt;
      &lt;servlet-name&gt;JMSSenderAMQ&lt;/servlet-name&gt;
      &lt;url-pattern&gt;*.html&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    
    &lt;resource-ref&gt;
      &lt;description&gt;JMS Connection&lt;/description&gt;
      &lt;res-ref-name&gt;jms/ConnectionFactory&lt;/res-ref-name&gt;
      &lt;res-type&gt;org.apache.activemq.ActiveMQConnectionFactory&lt;/res-type&gt;
      &lt;res-auth&gt;Container&lt;/res-auth&gt;
      &lt;res-sharing-scope&gt;Shareable&lt;/res-sharing-scope&gt;
    &lt;/resource-ref&gt;
    
    &lt;resource-ref&gt;
      &lt;res-ref-name&gt;jms/FooQueue&lt;/res-ref-name&gt;
      &lt;res-type&gt;javax.jms.Queue&lt;/res-type&gt;
      &lt;res-auth&gt;Container&lt;/res-auth&gt;
      &lt;res-sharing-scope&gt;Shareable&lt;/res-sharing-scope&gt;
    &lt;/resource-ref&gt;
  &lt;/web-app&gt;



</pre>
    <br />
    <u>/WEB-INF/JMSSenderAMQ-servlet.xml</u>
    <br /> Next is to update the servlet contexy of sender application
    <br /> Nothing special, just need annotation configuration for controller
    <br />
    <br />
    <br />
    <pre class="prettyprint lang-xml">




&lt;beans xmlns:context=&quot;http://www.springframework.org/schema/context&quot; xmlns:p=&quot;http://www.springframework.org/schema/p&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns=&quot;http://www.springframework.org/schema/beans&quot; xsi:schemalocation=&quot;
  http://www.springframework.org/schema/beans  http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
  http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-2.5.xsd&quot;&gt;

  &lt;context:component-scan base-package=&quot;com.icodingclub.jms.web&quot;&gt;&lt;/context:component-scan&gt;
  
  &lt;bean class=&quot;org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerAdapter&quot;&gt;&lt;/bean&gt;
  
  &lt;bean class=&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot; p:prefix=&quot;/WEB-INF/jsp/&quot; p:suffix=&quot;.jsp&quot;&gt;&lt;/bean&gt;
  
&lt;/beans&gt;

</pre>
    <br />
    <br />
    <br />
    <u>/WEB-INF/spring/jms-context.xml</u>
    <br /> This is the first, very important file.
    <br /> Things to note down here are
    <br />
    <ol>
        <li><span style="font-size: large;"><span style="font-size: small;">JNDI setup for connection</span></span>
        </li>
        <li><span style="font-size: large;"><span style="font-size: small;">JNDI setup for queue name</span></span>
        </li>
        <li><span style="font-size: large;"><span style="font-size: small;">connection and session pooling (cachedConnectionFactory)</span><u><br />
</u>
            </span>
        </li>
    </ol>
    <br />
    <br />
    <pre class="prettyprint lang-xml">


&lt;beans xmlns:jee=&quot;http://www.springframework.org/schema/jee&quot; xmlns:jms=&quot;http://www.springframework.org/schema/jms&quot; xmlns:p=&quot;http://www.springframework.org/schema/p&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns=&quot;http://www.springframework.org/schema/beans&quot; xsi:schemalocation=&quot;
    http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee.xsd
    http://www.springframework.org/schema/jms http://www.springframework.org/schema/jms/spring-jms.xsd&quot;&gt;

  &lt;jee:jndi-lookup cache=&quot;true&quot; expected-type=&quot;org.apache.activemq.ActiveMQConnectionFactory&quot; id=&quot;connectionFactory&quot; jndi-name=&quot;java:comp/env/jms/ConnectionFactory&quot; lookup-on-startup=&quot;true&quot; proxy-interface=&quot;javax.jms.ConnectionFactory&quot; resource-ref=&quot;true&quot;&gt;&lt;/jee:jndi-lookup&gt;

  &lt;jee:jndi-lookup cache=&quot;true&quot; expected-type=&quot;org.apache.activemq.command.ActiveMQQueue&quot; id=&quot;fooQueue&quot; jndi-name=&quot;java:comp/env/jms/FooQueue&quot; lookup-on-startup=&quot;true&quot; proxy-interface=&quot;javax.jms.Queue&quot; resource-ref=&quot;true&quot;&gt;&lt;/jee:jndi-lookup&gt;


  &lt;bean class=&quot;org.springframework.jms.connection.CachingConnectionFactory&quot; id=&quot;cachedConnectionFactory&quot; p:sessioncachesize=&quot;10&quot; p:targetconnectionfactory-ref=&quot;connectionFactory&quot;&gt;&lt;/bean&gt;


  &lt;bean class=&quot;org.springframework.jms.core.JmsTemplate&quot; id=&quot;jmsTemplate&quot; p:connectionfactory-ref=&quot;cachedConnectionFactory&quot; p:defaultdestination-ref=&quot;fooQueue&quot;&gt;&lt;/bean&gt;

  &lt;bean class=&quot;com.icodingclub.jms.service.AMQMsgSenderService&quot; id=&quot;messageSenderService&quot; p:jmstemplate-ref=&quot;jmsTemplate&quot;&gt;&lt;/bean&gt;

&lt;/beans&gt;

</pre>
    <br />
    <br />
    <br />
    <u>com.icodingclub.jms.web.ProducerController</u>
    <br />
    <br /> This is sender controller, nothing special here
    <br />
    <br />
    <pre class="prettyprint lang-java">


package com.icodingclub.jms.web;

import java.io.IOException;
import java.util.Calendar;

import org.apache.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

import com.icodingclub.jms.service.MsgSenderService;

/**
 * @author Praveen k Singh
 * 
 */
@Controller
public class ProducerController
{

 private static final Logger LOG = Logger.getLogger(ProducerController.class);

        @Autowired
 private AMQMsgSenderService messageSenderService;

 @RequestMapping(value = "/amqTest.html", method = RequestMethod.GET)
 public void amqLoadTest() throws IOException
 {
  LOG.info("Inside Controller");

  Calendar cal = Calendar.getInstance();
  try
  {
   messageSenderService.sendMessage("Message on: " + cal);
  }
  catch (Exception e)
  {
   e.printStackTrace();
  }
 }

}

</pre>
    <br />
    <u>com.icodingclub.jms.service.AMQMsgSenderService</u>
    <br /> Service class for sender its task is to create the JMS message.
    <br /> Right now it is TextMessage, but can be changed to any other message type
    <br />
    <br />
    <br />
    <br />
    <pre class="prettyprint lang-java">

package com.icodingclub.jms.service;

import javax.jms.JMSException;
import javax.jms.Message;
import javax.jms.Session;
import javax.jms.TextMessage;

import org.apache.log4j.Logger;
import org.springframework.jms.core.JmsTemplate;
import org.springframework.jms.core.MessageCreator;


/**
 * @author Praveen k Singh
 * 
 */
public class AMQMsgSenderService
{

  private static final Logger LOG = Logger.getLogger(AMQMsgSenderService.class);
  
  private JmsTemplate jmsTemplate;

  public void sendMessage(final String msg) throws JMSException
  {
    jmsTemplate.send(new MessageCreator()
    {
      public Message createMessage(Session session) throws JMSException
      {
        LOG.info("SENDING: " + msg);
        TextMessage message = session.createTextMessage(msg);
        return message;
      }
    });
  }

  public void setJmsTemplate(JmsTemplate jmsTemplate)
  {
    this.jmsTemplate = jmsTemplate;
  }

}

</pre>
    <br />
    <br />
    <u>Building JMSListnerAMQ </u>
    <br />
    <br /> Lest start building the JMSListner jar.
    <br /> It will be new web project
    <br />
    <br />
    <br />
    <u>JMSListner Server configuration</u>
    <br /> Dump all jars again in Listner server
    <br /> do the config changes
    <br />
    <br />
    <u>TOMCAT_LIS_PATH/conf/server.xml</u>
    <br />
    <pre class="prettyprint lang-xml">


&lt;resource auth=&quot;Container&quot; brokername=&quot;FooBroker&quot; brokerurl=&quot;vm://localhost?brokerConfig=xbean:conf/activemq.xml&quot; description=&quot;JMS Connection Factory&quot; factory=&quot;org.apache.activemq.jndi.JNDIReferenceFactory&quot; name=&quot;jms/ConnectionFactory&quot; type=&quot;org.apache.activemq.ActiveMQConnectionFactory&quot;&gt;&lt;/resource&gt;
  
  &lt;resource auth=&quot;Container&quot; description=&quot;A sample queue&quot; factory=&quot;org.apache.activemq.jndi.JNDIReferenceFactory&quot; name=&quot;jms/FooQueue&quot; physicalname=&quot;TEST.Q1&quot; type=&quot;org.apache.activemq.command.ActiveMQQueue&quot;&gt;&lt;/resource&gt;


</pre>
    <br />
    <br />
    <u>TOMCAT_LIS_PATH/conf/context.xml</u>
    <br />
    <br />
    <pre class="prettyprint lang-xml">


&lt;resourcelink global=&quot;jms/ConnectionFactory&quot; name=&quot;jms/ConnectionFactory&quot;&gt;
  &lt;resourcelink global=&quot;jms/FooQueue&quot; name=&quot;jms/FooQueue&quot;&gt;
&lt;/resourcelink&gt;&lt;/resourcelink&gt;



</pre>
    <br />
    <br />
    <u>/WEB-INF/web.xml</u>
    <br />
    <br />
    <ol>
        <li><span style="font-size: large;"><span style="font-size: small;">Application context setup with servlet context</span></span>
        </li>
        <li><span style="font-size: large;"><span style="font-size: small;">JNDI setup for connection</span></span>
        </li>
        <li><span style="font-size: large;"><span style="font-size: small;">JNDI setup for queue name</span><u><br />
</u>
            </span>
        </li>
    </ol>
    <br />
    <pre class="prettyprint lang-xml">


&lt;web-app id=&quot;WebApp_ID&quot; version=&quot;2.5&quot; xmlns:web=&quot;http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot; xsi:schemalocation=&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot;&gt;
  &lt;context-param&gt;
    &lt;param-name&gt;log4jConfigLocation&lt;/param-name&gt;&lt;param-value&gt;/WEB-INF/classes/log4j.xml&lt;/param-value&gt;&lt;/context-param&gt;
  &lt;listener&gt;
    &lt;listener-class&gt;org.springframework.web.util.Log4jConfigListener&lt;/listener-class&gt;
  &lt;/listener&gt;
  &lt;context-param&gt;
    &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;&lt;param-value&gt;/WEB-INF/spring/jms-context.xml&lt;/param-value&gt;&lt;/context-param&gt;
  &lt;listener&gt;
    &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;
  &lt;/listener&gt;
  &lt;servlet&gt;
    &lt;servlet-name&gt;JMSListnerAMQ&lt;/servlet-name&gt;
    &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;
    &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
  &lt;/servlet&gt;
  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;JMSListnerAMQ&lt;/servlet-name&gt;
    &lt;url-pattern&gt;*.html&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
  &lt;resource-ref&gt;
    &lt;description&gt;JMS Connection&lt;/description&gt;
    &lt;res-ref-name&gt;jms/ConnectionFactory&lt;/res-ref-name&gt;
    &lt;res-type&gt;org.apache.activemq.ActiveMQConnectionFactory&lt;/res-type&gt;
    &lt;res-auth&gt;Container&lt;/res-auth&gt;
    &lt;res-sharing-scope&gt;Shareable&lt;/res-sharing-scope&gt;
  &lt;/resource-ref&gt;
  &lt;resource-ref&gt;
    &lt;res-ref-name&gt;jms/FooQueue&lt;/res-ref-name&gt;
    &lt;res-type&gt;javax.jms.Queue&lt;/res-type&gt;
    &lt;res-auth&gt;Container&lt;/res-auth&gt;
    &lt;res-sharing-scope&gt;Shareable&lt;/res-sharing-scope&gt;
  &lt;/resource-ref&gt;
&lt;/web-app&gt;



</pre>
    <br />
    <br />
    <br />
    <u>/WEB-INF/JMXListnerAMQ-servlet.xml</u>
    <br />
    <br />
    <pre class="prettyprint lang-xml">



&lt;beans xmlns:context=&quot;http://www.springframework.org/schema/context&quot; xmlns:p=&quot;http://www.springframework.org/schema/p&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns=&quot;http://www.springframework.org/schema/beans&quot; xsi:schemalocation=&quot;
  http://www.springframework.org/schema/beans  http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
  http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-2.5.xsd&quot;&gt;
  &lt;context:component-scan base-package=&quot;com&quot;&gt;
  &lt;bean class=&quot;org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerAdapter&quot;&gt;
  &lt;bean class=&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot; p:prefix=&quot;/WEB-INF/jsp/&quot; p:suffix=&quot;.jsp&quot;&gt;
&lt;/bean&gt;&lt;/bean&gt;&lt;/context:component-scan&gt;&lt;/beans&gt;
&lt;/pre&gt;&lt;br /&gt;
&lt;br /&gt;
&lt;br /&gt;
&lt;u&gt;/WEB-INF/spring/jms-context.xml&lt;/u&gt;&lt;br /&gt;
&lt;br /&gt;
&lt;br /&gt;
&lt;pre class=&quot;prettyprint lang-xml&quot;&gt;&lt;beans xmlns:jee=&quot;http://www.springframework.org/schema/jee&quot; xmlns:jms=&quot;http://www.springframework.org/schema/jms&quot; xmlns:p=&quot;http://www.springframework.org/schema/p&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns=&quot;http://www.springframework.org/schema/beans&quot; xsi:schemalocation=&quot;
    http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee.xsd
    http://www.springframework.org/schema/jms http://www.springframework.org/schema/jms/spring-jms.xsd&quot;&gt;

  &lt;jee:jndi-lookup cache=&quot;true&quot; expected-type=&quot;org.apache.activemq.ActiveMQConnectionFactory&quot; id=&quot;connectionFactory&quot; jndi-name=&quot;java:comp/env/jms/ConnectionFactory&quot; lookup-on-startup=&quot;true&quot; proxy-interface=&quot;javax.jms.ConnectionFactory&quot; resource-ref=&quot;true&quot;&gt;&lt;/jee:jndi-lookup&gt;

  &lt;jee:jndi-lookup cache=&quot;true&quot; expected-type=&quot;org.apache.activemq.command.ActiveMQQueue&quot; id=&quot;fooQueue&quot; jndi-name=&quot;java:comp/env/jms/FooQueue&quot; lookup-on-startup=&quot;true&quot; proxy-interface=&quot;javax.jms.Queue&quot; resource-ref=&quot;true&quot;&gt;&lt;/jee:jndi-lookup&gt;


  &lt;bean class=&quot;org.springframework.jms.connection.CachingConnectionFactory&quot; id=&quot;cachedConnectionFactory&quot; p:sessioncachesize=&quot;10&quot; p:targetconnectionfactory-ref=&quot;connectionFactory&quot;&gt;&lt;/bean&gt;

  &lt;bean class=&quot;com.icodingclub.jms.listner.MessageListenerImpl&quot; id=&quot;simpleMessageListener&quot;&gt;&lt;/bean&gt;

  &lt;bean class=&quot;org.springframework.jms.listener.DefaultMessageListenerContainer&quot; id=&quot;jmsContainer&quot;&gt;
    &lt;property name=&quot;connectionFactory&quot; ref=&quot;cachedConnectionFactory&quot;&gt;&lt;/property&gt;
    &lt;property name=&quot;destination&quot; ref=&quot;fooQueue&quot;&gt;&lt;/property&gt;
    &lt;property name=&quot;messageListener&quot; ref=&quot;simpleMessageListener&quot;&gt;&lt;/property&gt;
    &lt;property name=&quot;maxConcurrentConsumers&quot; value=&quot;1&quot;&gt;&lt;/property&gt;
  &lt;/bean&gt;

&lt;/beans&gt;



</pre>
    <br />
    <u>conf/activemq.xml</u>
    <br /> The configuration file for ActiveMQ
    <br />
    <br />
    <pre class="prettyprint lang-xml">



&lt;beans xmlns:amq=&quot;http://activemq.apache.org/schema/core&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns=&quot;http://www.springframework.org/schema/beans&quot; xsi:schemalocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
  http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core-5.3.0.xsd&quot;&gt;

  &lt;bean class=&quot;org.springframework.beans.factory.config.PropertyPlaceholderConfigurer&quot;&gt;&lt;/bean&gt;

  &lt;broker brokername=&quot;FooBroker&quot; datadirectory=&quot;C:/activemq-5.5.0/data/&quot; usejmx=&quot;true&quot; xmlns=&quot;http://activemq.apache.org/schema/core&quot;&gt;

    &lt;managementcontext&gt;
      &lt;managementcontext connectorport=&quot;1099&quot; jmxdomainname=&quot;my-broker&quot;&gt;&lt;/managementcontext&gt;
    &lt;/managementcontext&gt;

    &lt;persistenceadapter&gt;
      
      &lt;kahadb directory=&quot;C:/activemq-5.5.0/data/kahadb&quot;&gt;&lt;/kahadb&gt;
    &lt;/persistenceadapter&gt;
    &lt;systemusage&gt;
      &lt;systemusage&gt;
        &lt;memoryusage&gt;
          &lt;memoryusage limit=&quot;128 mb&quot;&gt;&lt;/memoryusage&gt;
        &lt;/memoryusage&gt;
        &lt;storeusage&gt;
          &lt;storeusage limit=&quot;1 gb&quot;&gt;&lt;/storeusage&gt;
        &lt;/storeusage&gt;
        &lt;tempusage&gt;
          &lt;tempusage limit=&quot;100 mb&quot;&gt;&lt;/tempusage&gt;
        &lt;/tempusage&gt;
      &lt;/systemusage&gt;
    &lt;/systemusage&gt;

    &lt;transportconnectors&gt;
      &lt;transportconnector name=&quot;openwire&quot; uri=&quot;tcp://127.0.0.1:61616&quot;&gt;&lt;/transportconnector&gt;
    &lt;/transportconnectors&gt;

  &lt;/broker&gt;

&lt;/beans&gt;

</pre>



    <br />
    <br />
    <u>com.icodingclub.jms.listner.MessageListenerImpl</u>
    <br />
    <br />
    <pre class="prettyprint lang-java">package com.icodingclub.jms.listner;

import javax.jms.JMSException;
import javax.jms.Message;
import javax.jms.MessageListener;
import javax.jms.TextMessage;

import org.apache.log4j.Logger;

public class MessageListenerImpl implements MessageListener
{
 private static final Logger LOG = Logger.getLogger(MessageListenerImpl.class);

 public void onMessage(Message message)
 {
  if ((message instanceof TextMessage))
  {
   try
   {
    LOG.info("RECEIVED: MESSAGE ID: " + message.getJMSMessageID());
    LOG.info("RECEIVED: MESSAGE TEXT: " + ((TextMessage) message).getText());
   }
   catch (JMSException e)
   {
    e.printStackTrace();
   }
  }
 }
}

</pre>
    <br />
    <br />
    <u>rc/log4j.xml</u>
    <br />
    <u>&nbsp;</u>This is the common log4j file, will be used in both the application
    <br />
    <br />
    <br />
    <pre class="prettyprint lang-xml">



&lt;log4j:configuration debug=&quot;false&quot; xmlns:log4j=&quot;http://jakarta.apache.org/log4j/&quot;&gt;

  &lt;appender class=&quot;org.apache.log4j.ConsoleAppender&quot; name=&quot;CONSOLE-INFO&quot;&gt;
    &lt;layout class=&quot;org.apache.log4j.PatternLayout&quot;&gt;
      &lt;param name=&quot;ConversionPattern&quot; value=&quot;%-5p - %-30c{1} - %m%n&quot; /&gt;&lt;/layout&gt;
    &lt;filter class=&quot;org.apache.log4j.varia.LevelMatchFilter&quot;&gt;
      &lt;param name=&quot;levelToMatch&quot; value=&quot;info&quot; /&gt;&lt;param name=&quot;acceptOnMatch&quot; value=&quot;true&quot; /&gt;&lt;/filter&gt;
    &lt;filter class=&quot;org.apache.log4j.varia.DenyAllFilter&quot;&gt;
  &lt;/filter&gt;&lt;/appender&gt;

  &lt;logger name=&quot;org.apache&quot;&gt;
    &lt;level value=&quot;WARN&quot;&gt;
  &lt;/level&gt;&lt;/logger&gt;
  &lt;logger name=&quot;org.springframework&quot;&gt;
    &lt;level value=&quot;debug&quot;&gt;
  &lt;/level&gt;&lt;/logger&gt;
  &lt;logger name=&quot;org.apache.activemq&quot;&gt;
    &lt;level value=&quot;info&quot;&gt;
  &lt;/level&gt;&lt;/logger&gt;
  &lt;logger name=&quot;org.apache.activemq.store.kahadb&quot;&gt;
    &lt;level value=&quot;warn&quot;&gt;
  &lt;/level&gt;&lt;/logger&gt;
  &lt;logger name=&quot;com.icodingclub.jms&quot;&gt;
    &lt;level value=&quot;debug&quot;&gt;
  &lt;/level&gt;&lt;/logger&gt;

  &lt;root&gt;
    &lt;priority value=&quot;debug&quot;&gt;
    &lt;appender-ref ref=&quot;CONSOLE-INFO&quot;&gt;
  &lt;/appender-ref&gt;&lt;/priority&gt;&lt;/root&gt;

&lt;/log4j:configuration&gt;


</pre>
    <br />
    <br />
    <u>JMX Code</u>
    <br /> Lets move to the JMX portion.
    <br /> We have this simple class to monitor queue
    <br />
    <br />
    <pre class="prettyprint lang-java">package com.monitor;

import javax.management.MBeanServerConnection;
import javax.management.MBeanServerInvocationHandler;
import javax.management.ObjectName;
import javax.management.remote.JMXConnector;
import javax.management.remote.JMXConnectorFactory;
import javax.management.remote.JMXServiceURL;

import org.apache.activemq.broker.jmx.BrokerViewMBean;
import org.apache.activemq.broker.jmx.QueueViewMBean;

public class AMQMonitorManger
{

 public static void main(String[] args) throws Exception
 {
  JMXServiceURL url = new JMXServiceURL("service:jmx:rmi:///jndi/rmi://localhost:1099/jmxrmi");
  JMXConnector connector = JMXConnectorFactory.connect(url, null);
  connector.connect();
  MBeanServerConnection connection = connector.getMBeanServerConnection();
  ObjectName name = new ObjectName("my-broker:BrokerName=FooBroker,Type=Broker");

  BrokerViewMBean mbean = (BrokerViewMBean) MBeanServerInvocationHandler.newProxyInstance(
    connection, name, BrokerViewMBean.class, true);

  for (ObjectName queueName : mbean.getQueues())
  {
   QueueViewMBean queueMbean = (QueueViewMBean) MBeanServerInvocationHandler
     .newProxyInstance(connection, queueName, QueueViewMBean.class, true);

   if (queueMbean.getName().equals("TEST.Q1"))
   {
    System.out.println("enqueueCount: " + queueMbean.getEnqueueCount());
    System.out.println("dequeueCount: " + queueMbean.getDequeueCount());
    System.out.println("inFlightCount: " + queueMbean.getInFlightCount());
   }

  }
 }
}

</pre>
    <br />
    <br />

</section>
<section>
    <h1 class="section-heading">
        Demo Video
        <span class="arrow"></span>
    </h1>
    <br />
    <br />
    <iframe allowfullscreen="" frameborder="0" height="390" src="http://www.youtube.com/embed/9OedsIqfQ7A" width="649"></iframe>
    <br />
    <br />
    <br />
    <br />
    <u><span style="font-size: large;"><br />
</span></u>
    <br />

</section>
<section>

  <h1 class="section-heading">
        Code
        <span class="arrow"></span>
    </h1>
    <br />
    <br />
    <a href="https://docs.google.com/viewer?a=v&amp;pid=explorer&amp;chrome=true&amp;srcid=0B_QZ5kZNDADQNzE4NWQ3ZmEtNjYwYi00NmRmLTkzOTAtNTc0MGUzNTk3ZjFh&amp;hl=en_US%20">JMSSenderAMQ.zip</a><u><span style="font-size: large;"></span></u>
    <br />
    <u><span style="font-size: large;"><span style="font-size: small;"><a href="https://docs.google.com/viewer?a=v&amp;pid=explorer&amp;chrome=true&amp;srcid=0B_QZ5kZNDADQZDQwMmM3MDUtMzIxMy00NjJhLTk0MTEtYTdmYTMzYjA0NjVl&amp;hl=en_US">JMSListnerAMQ.zip</a></span><br />
</span></u>
    <br />
    <u><span style="font-size: large;"><span style="font-size: small;"><a href="https://docs.google.com/viewer?a=v&amp;pid=explorer&amp;chrome=true&amp;srcid=0B_QZ5kZNDADQYWY1NTlkOTYtNDJiYi00ZjBhLWJlMTEtYTViMjlmYWZhOWYx&amp;hl=en_US">AMQJMX.zip</a></span><br />
</span></u>
    <br />
    <u><span style="font-size: large;"><br />
</span></u>
    <br />
    <u><span style="font-size: large;"><br />
</span></u>
    <br />
</section>


<script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js?skin=sunburst"></script>
